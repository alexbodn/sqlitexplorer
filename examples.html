<!DOCTYPE html>
<!--
 * Copyright (C) 2023, 2024 Alex Bodnaru
 * 
 * This file is part of SQLiteXplorer.
 * SQLiteXplorer is free software: 
 * you can redistribute it and/or modify it 
 * under the terms of the 
 * GNU Lesser General Public License as 
 * published by the Free Software Foundation, 
 * either version 3 of the License, 
 * or (at your option) any later version.
 * SQLiteXplorer is distributed 
 * in the hope that it will be useful, 
 * but WITHOUT ANY WARRANTY; 
 * without even the implied warranty of 
 * MERCHANTABILITY or FITNESS FOR A 
 * PARTICULAR PURPOSE. 
 * See the GNU Lesser General Public License 
 * for more details.
 * You should have received a copy of the 
 * GNU Lesser General Public License along 
 * with SQLiteXplorer. If not, 
 * see <https://www.gnu.org/licenses/>.
-->
<html>
	<head>
		<meta charset="utf-8" />
		<script>
let displayLeaflet = false;
let type = 'spl';
//let type = 'sql';
//let dbFile = './tests/files/dbs/DCTour.gpkg';
//let dbFile = './tests/files/dbs/StLouis.gpkg';
let dbFile = './tests/files/dbs/london.gpkg';
//let dbFile = './tests/files/dbs/db_small.sqlite';
		</script>
		
		
		
		<script>
			async function jsLoad(src, module=false) {
				if (!src) {
					return Promise.resolve();
				}
				return new Promise((resolve, reject) => {
					let s = document.createElement('script');
					s.src = src;
					if (module) {
						s.type='module';
					}
					s.async = false;
					s.onload = resolve;
					s.onerror = reject;
					document.head.append(s);
				});
			}
		</script>
		<script>
			async function demosql(dbUrl) {
				const demo1 = function(sqlite3, dbUrl, immutable=false) {
					fetch(dbUrl)
					.then(res => res.arrayBuffer())
					.then(arrayBuffer => {
						if (!immutable) {
							arrayBuffer.resizeable = true;
						}
						const p = sqlite3.wasm.allocFromTypedArray(arrayBuffer);
						const db = new sqlite3.oo1.DB();
						let deserialize_flags =
							sqlite3.capi.SQLITE_DESERIALIZE_FREEONCLOSE;
						if (!immutable) {
							deserialize_flags |= sqlite3.capi.SQLITE_DESERIALIZE_RESIZEABLE;
						}
						const rc = sqlite3.capi.sqlite3_deserialize(
							db.pointer, 'main', p, arrayBuffer.byteLength, arrayBuffer.byteLength, deserialize_flags);
						db.checkRc(rc);
						window.xplorer.setDb(db);
					});
				};
				const log = (...args)=>xplorer.log(...args);
				const warn = (...args)=>xplorer.warn(...args);
				const error = (...args)=>xplorer.error(...args);
				
				sqlite3InitModule({
					/* We can redirect any stdout/stderr from the module like so, but
						 note that doing so makes use of Emscripten-isms, not
						 well-defined sqlite APIs. */
					print: log,
					printErr: error
				}).then(function(sqlite3){
					//console.log('sqlite3 =',sqlite3);
					log("Done initializing. Running demo...");
					try {
						demo1(sqlite3, dbUrl);
					}catch(e){
						error("Exception:",e.message);
					}
				});
			}
			async function demospl(dbUrl) {
				const autoGeoJSON = {
					precision: 15,
					options: 2,
				};
				
				spl = await window.SPL(
					{
						autoGeoJSON,
					},
					[],
				);
				
				let autogpkg = 1;
				let withgpkg = true;
				
				const projdbUrl = new URL(
					'./node_modules/spl.js/dist/proj/proj.db', window.location.href).toString();
				let projPromise = fetch(projdbUrl)
					.then(resp => resp.arrayBuffer())
					.then(projData => {
						return spl.mount('/proj', [{name: 'proj.db', data: projData}]);
					});
					
				let dataPromise = fetch(dbUrl)
					.then(resp => resp.arrayBuffer())
					.then(dbData => spl.db(dbData))
					.then(db => {
						try {
							db.read(`
								--nga gpkg have these hacks
								PRAGMA writable_schema = ON;
								--however drop view if exists
								--is the goto solution to these
								--removals, sqlite drop view if
								--exists throws an error if exists
								--a table with the same name,
								--if it exists in a spatialite db,
								--and they fail to understand it's
								--wrong.
								DELETE
								FROM sqlite_master
								WHERE type='view' AND name in (
									'spatial_ref_sys',
									'st_spatial_ref_sys',
									'geometry_columns',
									'st_geometry_columns'
								);
								PRAGMA writable_schema = RESET;
							`);
						}
						catch(err) {
						}
						finally {
							return db;
						}
					});
				Promise.all([projPromise, dataPromise])
					.then(([proj, db]) => {
						return db.read(init_spl({withgpkg, autogpkg}));
					})
					.then((db) => {
						window.xplorer.setDb(db);
					})
					;
			}
			
			function init_spl({projFile='/proj/proj.db', withgpkg=1, autogpkg=1}={}) {
				let pragmas = `
					PRAGMA foreign_keys = 1;
					PRAGMA recursive_triggers = 1;`;
				let init = `
					SELECT initspatialmetadatafull(1)
					where not exists (
						SELECT 1
						FROM sqlite_schema
						WHERE name LIKE 'geometry_columns'
					)
					;
					SELECT PROJ_SetDatabasePath('${projFile}'); -- set proj.db path
					`;
				let gpkg = `
					/**/
					SELECT EnableGpkgAmphibiousMode()
					WHERE getgpkgmode()=0;
					SELECT enablegpkgmode()
					WHERE GetGpkgAmphibiousMode()=0;
					/**/
					SELECT
						AutoGPKGStart(),
						--AutoGPKGStop(),
						''
					WHERE EXISTS (
						SELECT 1
						FROM sqlite_schema
						WHERE name LIKE 'gpkg_contents'
					)
					and ${autogpkg}=1
					`;
				if (!withgpkg) {
					gpkg = '';
				}
				return pragmas + init + gpkg;
			}
		</script>
		
		<style>
			body {
				/*margin: 0px;*/
				margin-left: 0;
				margin-right: 0;
			}
			div#sqlDiv, #map {
				width: 98vw;
				height: 59vh;
				margin-top: 1vh;
				margin-right: 1vw;
				margin-left: 1vw;
				border: solid 1px gray;
				
				/*position: fixed;*/
			}
		</style>
		<title>
			spl-view
		</title>
	</head>
	<body>
		<script>
Promise.all([
	jsLoad('./lib/map_show.js'),
])
.then(() => {
	return Promise.all([
		jsLoad("./lib/map_show_leaflet.js"),
		jsLoad("./lib/map_show_ol.js"),
	]);
})
.then(() => {
	window.DisplayClass = displayLeaflet ?
		DisplayLeaflet : DisplayOpenLayers;
	return Promise.all([
		jsLoad("./lib/sqlitexplorer.js"),
		window.DisplayClass.resources()
	]);
})
.then(() => {
	let html = `<div id="sqlDiv"></div>`;
	document.body.insertAdjacentHTML('beforeend', html);
	let div = document.querySelector('div#sqlDiv');
	window.xplorer = new SQLiteXplorer(div, {
		build_map: window.DisplayClass,
		withProj4JS: false,
	});
	const map = window.xplorer.getMap();
	map._addLayer(
		map.
		bw_layer()
		//osm_layer()
	);
	window.log = window.xplorer.log;
	return Promise.resolve();
})
.then(() => {
	return Promise.all([
		jsLoad("./lib/loadspl.js", true),
		jsLoad("./node_modules/@sqlite.org/sqlite-wasm/sqlite-wasm/jswasm/sqlite3.js"),
	]);
})
.then(() => {
	let dbUrl = new URL(dbFile,
		window.location.href).toString();
	if (type == 'spl') {
		demospl(dbUrl);
	}
	else {
		demosql(dbUrl);
	}
});
		</script>
	</body>
</html>
